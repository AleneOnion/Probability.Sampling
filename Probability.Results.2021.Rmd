---
title: "Probability Sampling Results"
author: "Alene Onion and Tony Olsen of USEPA"
date: "1/12/2021"
output: html_document
---

```{r GlobalOptions}
options(knitr.duplicate.label = 'allow')
```

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# {.tabset}
Historically, lakes were selected for NYS sampling based on their importance to recreation. We are shifting our focus to understand the health of NYS ponded waters for drinking water, recreation, and aquatic life designated uses. Therefore, we felt it was necessary to conduct an unbiased survey to best understand conditions across NYS ponded waters.

This analysis was conducted in collaboration with USEPA. Specifically, we collaborated with Tony Olsen and Michael Dumelle.

## Prepping data

Merging relevant raw data files and filtering to simply trophic status

Please note that these were the criteria for selecting the original data frame: restricted to waterbodies in the NHD classified as LakePond which includes reservoirs, restricted to those above 6.5 acres, within the boundaries of NYS, we further excluded wetlands by examining satellite imagery and removing sites that are more than 50% covered by emergent macrophytes

```{r, echo=TRUE, results='asis', message=FALSE, warning=FALSE}
#HI SABRINA!!!




################################################################################################################
#reading in and formatting raw data
################################################################################################################

library(tidyverse)
library(huxtable)
#raw data
lab<-read.csv("LCI.2020.qaqcd-2020-11.30_with_lakeID.csv")
sites<-read.csv("Probability_Based_Sites_2020.csv")
#no habs - none of the probability sites had any detectable level of microcystin so I added it as a 0 value at the end

#modify the data so it can be merged
lab<-lab %>% 
  mutate(sys_sample_code=substr(sys_sample_code,nchar(sys_sample_code),nchar(sys_sample_code))) %>% 
  filter(sys_sample_code!=2) %>% 
  mutate(chemical_name=paste(chemical_name,result_unit,sep="_"),
         #converting non-detects to 0
         result_value=ifelse(validator_qualifiers=="U",0,result_value)) %>% 
  select(LAKE,chemical_name,result_value) %>% 
  rename(LAKE_ID=LAKE)
sites<-sites %>% 
  rename(siteID=SITE_ID,
         xcoord=LON_DD83,
         ycoord=LAT_DD83,
         Eval_Status=EvalStatus) %>% 
  #removing sites that we haven't yet evaluated
  filter(Eval_Status!="") %>% 
  mutate(Eval_Status=trimws(Eval_Status),
         #the following sites were not sampled although we intended to EXCEPT canandaigua
         #NOTE - we need to add canandaigua data once it is generated by cslap
         Eval_Status=ifelse(LAKE_ID %in% c('0704CAN0286','0903UWBXXX1','1104PAR0432','1301PET0161G'),'Target_NoOwnerAccess',Eval_Status)) 

#now restrict to only the data in the probability study and spread the data
att<-merge(sites,lab,by=c('LAKE_ID'),all.x = TRUE)
att<-att %>% spread(chemical_name,result_value,fill = NA) %>% 
  #adding microcystin results
  mutate(`microcystin_ug/L` =0) %>% 
  #removing an NA column
  select(-`<NA>`) 

#selecting only trophic parameters and adding trophic status

###CHECK TO MAKE SURE THESE PARAMETERS ARE PRESENT IN BOTH 2020 and 2021
att<-att %>% 
  #removing parameters that aren't trophic parameters
  #we will process these later once we understand the analysis
  select(-`Arsenic_ug/l`,-`Calcium_ug/l`,-`Carbon, Dissolved Organic (DOC)_mg/l`,-`CHLORIDE (AS CL)_mg/l`,
         -`Color, True_color unit`,-`HARDNESS (AS CACO3)_mg/l`,-`Iron_ug/l`,-`Manganese_ug/l`,
         -`Nitrate+Nitrite as Nitrogen_mg/l`,-`Nitrogen, ammonia (As N)_mg/l`,
         -`NITROGEN, KJELDAHL, TOTAL_mg/l`,-`NITROGEN, NITRATE (AS N)_mg/l`,-`NITROGEN, NITRITE_mg/l`,
         -`pH of Color Analysis_pH units`,-`PHOSPHORUS, DISSOLVED (AS P)_mg/l`,
         -`SULFATE (AS SO4)_mg/l`,-`TOTAL ORGANIC CARBON_mg/l`,
         -`microcystin_ug/L`,-`UV 254_1/cm`,-`ALKALINITY, TOTAL (AS CaCO3)_mg/l`) %>% 
  #remove fields in the sites table that aren't relevant
  select(-Accessible,-Comments,-Contact,-X,-STATUS) %>% 
  mutate(phos_trophic="oligotrophic",
         phos_trophic=ifelse(`PHOSPHORUS, TOTAL (AS P)_mg/l`>0.01,"mesotrophic",phos_trophic),
         phos_trophic=ifelse(`PHOSPHORUS, TOTAL (AS P)_mg/l`>0.02,"eutrophic",phos_trophic),
         chla_trophic="oligotrophic",
         chla_trophic=ifelse(`Chlorophyll A_ug/l`>2,"mesotrophic",chla_trophic),
         chla_trophic=ifelse(`Chlorophyll A_ug/l`>8,"eutrophic",chla_trophic))
         #will have to add after we finalize the field data. These data are not yet available
         #secchi_trophic="oligotrophic",
         #secchi_trophic=ifelse(Result.Value>2,"mesotrophic",secchi_trophic),
         #secchi_trophic=ifelse(Result.Value>5,"eutrophic",secchi_trophic)) 

rm(list=setdiff(ls(), c("att")))
```

## Analysis

The start of the NYSAnalysis code from Tony Olsen

The results are weighted based on the distribution of the five size classes in the original data frame divided by the distribution in the samples evaluated. The purpose of this step is to account for oversampling in certain size classes.
PLEASE NOTE: the samples evaluated included the lakes that were actually sampled as well as the lakes which could not be sampled due to wetland status or access issues. After adjusting the weights, they should add up to the original frame size of 6437:

```{r, echo=TRUE, results='asis', message=FALSE, warning=FALSE}
# Create a Target/NonTarget status variable
att<-att %>% 
  mutate(statusTNT="Target",
         statusTNT=ifelse(Eval_Status=="NonTarget","NonTarget",statusTNT))

#Calculate the adjusted weights
#The numerator is the original frame size value
#the denominator is the actual number of samples evaluated in each category

att<-att %>% 
  mutate(WgtAdj=NA,
         WgtAdj=ifelse(PROB_CAT=="(1,4]",((1828/17)),WgtAdj),
         WgtAdj=ifelse(PROB_CAT=="(4,10]",((2490/9)),WgtAdj),
         WgtAdj=ifelse(PROB_CAT=="(10,20]",((1003/11)),WgtAdj),
         WgtAdj=ifelse(PROB_CAT=="(20,50]",((616/13)),WgtAdj),
         WgtAdj=ifelse(PROB_CAT==">50",((500/18)),WgtAdj))

#should add up to 6437
print(sum(att$WgtAdj))
```

Non-target samples are those determined to be wetlands using GIS analysis. Target samples include lakes actually sampled as well as lakes we intended to sample but couldn't for access or wetland status reasons. 
The following code uses the sample population of target/non-target samples (NResp) to project how many of the total 6437 lakes in our data frame would have been target/non-target (Estimate.U) as well as the 95% confidence interval (LCB95Pct.U and UCB95Pct.U).

```{r, echo=TRUE, results='asis', message=FALSE, warning=FALSE}
framesize_LC <- c("New York State"=68)

# Estimate TNT extent
# sites <- data.frame(siteID=att$siteID, Use=rep(TRUE, nrow(att)))
# subpop <- data.frame(siteID=att$siteID,
#                      PROB_CAT=att$PROB_CAT,
#                      NYS=att$STRATUM)
# design <- data.frame(siteID=att$siteID,
#                      wgt=att$WgtAdj,
#                      xcoord=att$xcoord,
#                      ycoord=att$ycoord)
# dataTNT <- data.frame(siteID=att$siteID, StatusTNT=att$statusTNT)
library(spsurvey)
TNTextent <- cat_analysis(
  dframe=att,
  vars=c("statusTNT"),
  subpops = ,
  siteID = "siteID",
  weight = "WgtAdj",
  xcoord = "xcoord",
  ycoord = "ycoord")
table <- TNTextent %>% select(Category,nResp,Estimate.U,LCB95Pct.U,UCB95Pct.U)
hux <- as_hux(table)
theme_plain(hux)

```

This code uses the same logic to estimate the ratios in the target population that were actually sampled versus inaccessible or wetland status.


```{r, echo=TRUE, results='asis', message=FALSE, warning=FALSE}
# Estimate Target extent reasons
target.att <- att[att$statusTNT=="Target",]
# dataTarget <- data.frame(siteID=att$siteID, TargetReason=att$Eval_Status)
TargetExtent <- TNTextent <- cat_analysis(
  dframe=target.att,
  vars=c("Eval_Status"),
  subpops = ,
  siteID = "siteID",
  weight = "WgtAdj",
  xcoord = "xcoord",
  ycoord = "ycoord")
table <- TargetExtent %>% select(Category,nResp,Estimate.U,LCB95Pct.U,UCB95Pct.U)
hux <- as_hux(table)
theme_plain(hux)
```

The conclusion is that only 1536-3310 lakes in our data frame of 6437 lakes are likely possible to sample. This is valuable to know because we always understood there are far too many lakes in NYS for us to possibly sample. This analysis indicates a large number are likely inaccessible or unsuitable and therefore the actually population we could sample is within the range that is actually possible in the 10yr sampling window.


The following code actually performs the analysis. It uses the number of sampled lakes in each trophic category (both for phosphorus and chlorophyll) to estimate the ratio of the 2423 lakes we could have sampled are eutrophic, mesotrophic, or eutrophic. 

PLEAE NOTE: this presumes that the lakes we didn't sample were random. A reasonable assumption but it's obviously preferable to sample all the lakes in the list to avoid this uncertainty. We certainly should keep this in mind as we are selecting sites for 2021 sampling.

```{r, echo=TRUE, results='asis', message=FALSE, warning=FALSE}
#  Estimate assessment result
# sites <- data.frame(siteID=att$siteID, Use=att$Eval_Status == "Target_Sampled")
CatExtent <- cat_analysis(
  dframe=att,
  vars=c("phos_trophic","chla_trophic"),
  subpops = ,
  siteID = "siteID",
  weight = "WgtAdj",
  xcoord = "xcoord",
  ycoord = "ycoord")

#quickly calculate the percentages
totals<-CatExtent %>% 
  select(Indicator,Category,Estimate.U) %>% 
  rename(total=Estimate.U)
totals$total <- CatExtent$Estimate.U[4]
CatExtent<-merge(CatExtent,totals,by=c('Indicator','Category'),all.x = TRUE)

forplot<-CatExtent %>% 
  mutate(pct=(Estimate.U/total)*100,
         pct_lcb=(LCB95Pct.U/total)*100,
         pct_ucb=(UCB95Pct.U/total)*100) %>% 
  select(Indicator,Category,pct,pct_lcb,pct_ucb) %>% 
  distinct() %>% 
  filter(Category!="Total") %>% 
  gather(percent,results,-Indicator,-Category) %>% 
  mutate(Indicator=ifelse(Indicator=="chla_trophic","Trophic Status from ChlA",Indicator),
         Indicator=ifelse(Indicator=="phos_trophic","Trophic Status from Phosphorus",Indicator))

table <- forplot %>% spread(percent,results)  %>% rename(Percentage=pct,Lower95Confidence=pct_lcb,Upper95Confidence=pct_ucb)
hux <- as_hux(table)
theme_plain(hux)

library(ggplot2)
ggplot(forplot) +
  geom_point(aes(x = Category, y = results, shape=percent))+
  scale_shape_manual(values=c(16,3,3))+
  theme(legend.position = "none")+
  facet_wrap(~Indicator,scales = "free_y")+
  labs(title="Distribution of trophic classes across NYS Ponded Waters",y="Percent of Total",x="Trophic Status")
```

## Comparison to LMAS Samples

A plot below shows the distribution of the size classes included in the data frame. For comparison, I've plotted the proportion of NYS lakes sampled in each size class since 2010.

```{r, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
#Plotting data frame distribution as well as NYS sample distribution collected since 2010
frame<-att %>% select(PROB_CAT,AREA_CAT) %>% rename(size_category=AREA_CAT) %>% distinct() %>% 
  mutate(Probability_Sites=ifelse(size_category=="(1,4]",((1828/6437)*100),size_category),
         Probability_Sites=ifelse(size_category=="(4,10]",((2490/6437)*100),Probability_Sites),
         Probability_Sites=ifelse(size_category=="(10,20]",((1003/6437)*100),Probability_Sites),
         Probability_Sites=ifelse(size_category=="(20,50]",((616/6437)*100),Probability_Sites),
         Probability_Sites=ifelse(size_category==">50",((500/6437)*100),Probability_Sites),
         LMAS_Sites=ifelse(size_category=="(1,4]",(7.64),size_category),
         LMAS_Sites=ifelse(size_category=="(4,10]",(16.7),LMAS_Sites),
         LMAS_Sites=ifelse(size_category=="(10,20]",(16.2),LMAS_Sites),
         LMAS_Sites=ifelse(size_category=="(20,50]",(19.3),LMAS_Sites),
         LMAS_Sites=ifelse(size_category==">50",(40.1),LMAS_Sites),) %>% 
  select(-PROB_CAT) %>% 
  gather(study,percentage,-size_category) %>% 
  arrange(study,size_category) %>% 
  mutate(percentage=as.numeric(percentage),
         size_category=factor(size_category,levels=c("(1,4]","(4,10]","(10,20]","(20,50]",">50")))
library(ggplot2)
ggplot(frame, aes(x=size_category,y=percentage,fill=study)) +
  geom_bar(stat = "identity", position = position_dodge())+
  labs(title="Size classes in the Probability Study versus LMAS samples since 2010",y="Percent of Total",x="Size Category (hectares)")
```

And the following plot shows the comparison of trophic distributions among LMAS most recent august samples since 2010 compared to the probability drawn samples.
NOTE: used ecoregion analysis to generate the LMAS numbers. These are the most recent August sample collected from each lake sampled since 2010 (a total of 473 unique lakes were sampled since 2010).

```{r, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
forplot2<-forplot %>% 
  spread(percent,results) %>% 
  rename(percent=pct) %>% 
  mutate(study="probability") %>% 
  add_row(Indicator="Trophic Status from ChlA",Category="eutrophic",study="LMAS",percent=((215/473)*100)) %>% 
  add_row(Indicator="Trophic Status from ChlA",Category="mesotrophic",study="LMAS",percent=((182/473)*100)) %>% 
  add_row(Indicator="Trophic Status from ChlA",Category="oligotrophic",study="LMAS",percent=((76/473)*100)) %>% 
  add_row(Indicator="Trophic Status from Phosphorus",Category="eutrophic",study="LMAS",percent=((211/473)*100)) %>% 
  add_row(Indicator="Trophic Status from Phosphorus",Category="mesotrophic",study="LMAS",percent=((141/473)*100)) %>% 
  add_row(Indicator="Trophic Status from Phosphorus",Category="oligotrophic",study="LMAS",percent=((121/473)*100)) %>% 
  mutate(pct_lcb=ifelse(is.na(pct_lcb),percent,pct_lcb),
         pct_ucb=ifelse(is.na(pct_ucb),percent,pct_ucb))
  

library(ggplot2)
ggplot(forplot2, aes(x=Category,fill=study)) +
  geom_bar(aes(y=percent),stat = "identity", position = position_dodge())+
  geom_errorbar(aes(ymin=pct_lcb, ymax=pct_ucb), width=.2,
                 position=position_dodge(.9))+
  facet_wrap(~Indicator,scales = "free_y")+
  labs(title="Trophic Classes in the Probability Study versus LMAS samples since 2010",y="Percent of Total",x="Trophic Classes")
```


## Notes for future study:

To consider the influence of other strata (such as depth or ecoregion) keep the adjusted weights the same and use these categories to define sub populations. If we include two sub populations (see how large shallow lakes fair in trophic status) then it's sliced so thin that the confidence interval is really too large to be of any value. 
The question then is when is it valuable to stratify a study as opposed to using subpopulations in the post analysis? The answer is that it depends on the distribution of sub populations. If one of the sub populations is very small compared to the other, for example Long Island samples versus samples from other eco regions, then we would probably want to stratify the samples to ensure we get a representative set from Long Island. If the sub populations are relatively equal, then there's no reason to stratify.
