---
title: "Probability Sampling Results 2021"
author: "Alene Onion and Tony Olsen of USEPA (updated by Sabrina Xie)"
date: "Last compiled `r format(Sys.time(), '%d %B, %Y, %X')`"
output: html_document
---

```{r GlobalOptions}
options(knitr.duplicate.label = 'allow')
```

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# {.tabset}
Historically, lakes were selected for NYS sampling based on their importance to recreation. We are shifting our focus to understand the health of NYS ponded waters for drinking water, recreation, and aquatic life designated uses. Therefore, we felt it was necessary to conduct an unbiased survey to best understand conditions across NYS ponded waters.

This analysis was conducted in collaboration with USEPA. Specifically, we collaborated with Tony Olsen and Michael Dumelle.

## Prepping data

Merging relevant raw data files and filtering to simply trophic status

Please note that these were the criteria for selecting the original data frame: restricted to waterbodies in the NHD classified as LakePond which includes reservoirs, restricted to those above 6.5 acres, within the boundaries of NYS, we further excluded wetlands by examining satellite imagery and removing sites that are more than 50% covered by emergent macrophytes

```{r, echo=TRUE, results='asis', message=FALSE, warning=FALSE}
################################################################################################################
#reading in and formatting raw data
################################################################################################################

library(tidyverse)
library(huxtable)
library(ggplot2)

# retrieve raw data from database
setwd("~/OneDrive - New York State Office of Information Technology Services/Rscripts/Current")
source("new_database/Reading.LMAS.Data.R")
setwd("~/OneDrive - New York State Office of Information Technology Services/Rscripts/Probability.Sampling/")

rm(list=setdiff(ls(), c('newdata')))
lab<-newdata %>%
  filter(SAMPLE_DATE>'2020-01-01') %>%
  mutate(combined=paste(CHARACTERISTIC_NAME,
                        INFORMATION_TYPE,
                        RSLT_RESULT_SAMPLE_FRACTION,
                        sep = "_"))  %>%
  select(LAKE_HISTORY_ID,
         SAMPLE_DATE,
         combined,
         RSLT_RESULT_VALUE,
         RSLT_LABORATORY_QUALIFIER,
         RSLT_VALIDATOR_QUALIFIER) %>%
  mutate(RSLT_RESULT_VALUE=ifelse(!is.na(RSLT_LABORATORY_QUALIFIER)&(RSLT_LABORATORY_QUALIFIER=="U"|RSLT_LABORATORY_QUALIFIER=="UE"),"0",RSLT_RESULT_VALUE),
         RSLT_RESULT_VALUE=as.numeric(RSLT_RESULT_VALUE)) %>%
  filter(!is.na(RSLT_RESULT_VALUE),
         !is.na(RSLT_VALIDATOR_QUALIFIER)|(RSLT_VALIDATOR_QUALIFIER!="R"),
         combined %in% c('CHLOROPHYLL A_OW_TOTAL',
                         'PHOSPHORUS, TOTAL_OW_TOTAL',
                         "MICROCYSTIN_OW_NA",
                         "NITROGEN, NITRATE-NITRITE_OW_TOTAL",
                         "NITROGEN, KJELDAHL, TOTAL_OW_TOTAL",
                         "NITROGEN, TOTAL_OW_TOTAL")) %>%
  select(LAKE_HISTORY_ID,SAMPLE_DATE,combined,RSLT_RESULT_VALUE) %>%
  distinct(LAKE_HISTORY_ID,SAMPLE_DATE,combined,.keep_all = TRUE) %>%
  rename(LAKE_ID=LAKE_HISTORY_ID,
         chemical_name=combined,
         result_value=RSLT_RESULT_VALUE)


# read in site data
sites<-read.csv("Probability_Based_Sites_2020_2021.csv")
sites<-sites %>% 
  rename(siteID=SITE_ID,
         xcoord=LON_DD83,
         ycoord=LAT_DD83,
         Eval_Status=EvalStatus) %>% 
  #removing sites that we haven't yet evaluated
  filter(Eval_Status!="") %>% 
  mutate(Eval_Status=trimws(Eval_Status))

# restrict to only the data in the probability study and spread the data
att<-merge(sites,lab,by=c('LAKE_ID'),all.x = TRUE)
att<-att %>% spread(chemical_name,result_value,fill = NA) %>% 
  # removing an NA column
  select(-`<NA>`) 

# selecting parameters and adding trophic status
att<-att %>% 
  # remove fields in the sites table that aren't relevant
  select(-Accessible,-Comments,-Contact,-STATUS) %>%
  # create total nitrogen
  mutate(`NITROGEN, TOTAL`=case_when(
    !is.na(`NITROGEN, KJELDAHL, TOTAL_OW_TOTAL`) ~
      (`NITROGEN, NITRATE-NITRITE_OW_TOTAL`+`NITROGEN, KJELDAHL, TOTAL_OW_TOTAL`),
    is.na(`NITROGEN, KJELDAHL, TOTAL_OW_TOTAL`) ~ `NITROGEN, TOTAL_OW_TOTAL`)) %>%
  # trophic status
  mutate(phos_trophic=case_when(
    `PHOSPHORUS, TOTAL_OW_TOTAL`<=0.01 ~ "oligotrophic",
    between(`PHOSPHORUS, TOTAL_OW_TOTAL`,0.01,0.02) ~ "mesotrophic",
    `PHOSPHORUS, TOTAL_OW_TOTAL`>=0.02 ~ "eutrophic")) %>%
  mutate(chla_trophic=case_when(
    `CHLOROPHYLL A_OW_TOTAL`<=2 ~ "oligotrophic",
    between(`CHLOROPHYLL A_OW_TOTAL`,2,8) ~ "mesotrophic",
    `CHLOROPHYLL A_OW_TOTAL`>=8 ~ "eutrophic")) %>%
  # EPA thresholds
  mutate(TP_threshold=case_when(
    `PHOSPHORUS, TOTAL_OW_TOTAL`<=0.016 ~ "Good",
    between(`PHOSPHORUS, TOTAL_OW_TOTAL`, 0.016, 0.0279) ~ "Fair",
    `PHOSPHORUS, TOTAL_OW_TOTAL`>=0.0279 ~ "Poor")) %>%
  mutate(TN_threshold=case_when(
    `NITROGEN, TOTAL`<=0.428 ~ "Good",
    between(`NITROGEN, TOTAL`, 0.428, 0.655) ~ "Fair",
    `NITROGEN, TOTAL`>=0.655 ~ "Poor")) %>%
  mutate(CHLA_threshold=case_when(
    `CHLOROPHYLL A_OW_TOTAL`<=0.00452 ~ "Good",
    between(`PHOSPHORUS, TOTAL_OW_TOTAL`, 0.00452, 0.00843) ~ "Fair",
    `PHOSPHORUS, TOTAL_OW_TOTAL`>=0.00843 ~ "Poor")) %>%
  # microcystin
  mutate(microcystin=case_when(
    is.na(`MICROCYSTIN_OW_NA`) ~"Least disturbed",
    `MICROCYSTIN_OW_NA`<8 ~ "Least disturbed",
    `MICROCYSTIN_OW_NA`>=8 ~ "Most disturbed"))
  # # dissolved oxygen
  # mutate(d.oxygen=case_when(
  #   `?`<=3 ~ "Poor",
  #   between(`?`, 3, 5) ~ "Fair",
  #   `?`>=5 ~ "Good"))

```

## Analysis

The start of the NYSAnalysis code from Tony Olsen

The results are weighted based on the distribution of the five size classes in the original data frame divided by the distribution in the samples evaluated. The purpose of this step is to account for oversampling in certain size classes.
PLEASE NOTE: the samples evaluated included the lakes that were actually sampled as well as the lakes which could not be sampled due to wetland status or access issues. After adjusting the weights, they should add up to the original frame size of 6437:

```{r, echo=TRUE, results='asis', message=FALSE, warning=FALSE}
# Create a Target/NonTarget status variable
att<-att %>% 
  mutate(statusTNT="Target",
         statusTNT=ifelse(Eval_Status=="NonTarget","NonTarget",statusTNT))

# get duplicates (multiple samples of same lake)
n_occur <- data.frame(table(att$FID))
dupes <- att[att$FID %in% n_occur$Var1[n_occur$Freq > 1],]
dupes <- unique(dupes$LAKE_ID)

# remove duplicates
n_att <- att %>% 
  arrange(FID,desc(SAMPLE_DATE))
n_att <- n_att[!duplicated(n_att$FID),]
att <- n_att %>%
  # remove extra columns
  select(-c('CHLOROPHYLL A_OW_TOTAL',
            'PHOSPHORUS, TOTAL_OW_TOTAL',
            "MICROCYSTIN_OW_NA",
            "NITROGEN, NITRATE-NITRITE_OW_TOTAL",
            "NITROGEN, KJELDAHL, TOTAL_OW_TOTAL",
            "NITROGEN, TOTAL_OW_TOTAL",
            "NITROGEN, TOTAL"))

# Calculate the adjusted weights
# The numerator is the original frame size value
# the denominator is the actual number of samples evaluated in each category

#number of lakes in each probability category
cats <- data.frame(
  PROB_CAT=unique(n_att$PROB_CAT),
  n=as.double(1,2,3,4,5))

for(i in 1:5){
  b <- cats[i,1]
  a <- n_att %>%
    filter(PROB_CAT==b)
  cats[i,2] <- nrow(a)
}

# add adjusted weight variable
att<-att %>% 
  mutate(WgtAdj=case_when(
         PROB_CAT=="(1,4]"~(1828/29),
         PROB_CAT=="(4,10]"~(2490/15),
         PROB_CAT=="(10,20]"~(1003/18),
         PROB_CAT=="(20,50]"~(616/21),
         PROB_CAT==">50"~(500/33)))

# should add up to 6437
print(sum(att$WgtAdj))
```

Non-target samples are those determined to be wetlands using GIS analysis. Target samples include lakes actually sampled as well as lakes we intended to sample but couldn't for access or wetland status reasons. 
The following code uses the sample population of target/non-target samples (NResp) to project how many of the total 6437 lakes in our data frame would have been target/non-target (Estimate.U) as well as the 95% confidence interval (LCB95Pct.U and UCB95Pct.U).

```{r, echo=TRUE, results='asis', message=FALSE, warning=FALSE}
framesize_LC <- c("New York State"=116) 

# Estimate TNT extent
library(spsurvey)
TNTextent <- cat_analysis(
  dframe=att,
  vars=c("statusTNT"),
  subpops = ,
  siteID = "siteID",
  weight = "WgtAdj",
  xcoord = "xcoord",
  ycoord = "ycoord")
table <- TNTextent %>% select(Category,nResp,Estimate.U,LCB95Pct.U,UCB95Pct.U)
hux <- as_hux(table)
number_format(hux) <- 2
theme_plain(hux)

```

This code uses the same logic to estimate the ratios in the target population that were actually sampled versus inaccessible or wetland status.

```{r, echo=TRUE, results='asis', message=FALSE, warning=FALSE}
# Estimate Target extent reasons
target.att <- att[att$statusTNT=="Target",]
TargetExtent <- cat_analysis(
  dframe=target.att,
  vars=c("Eval_Status"),
  subpops = ,
  siteID = "siteID",
  weight = "WgtAdj",
  xcoord = "xcoord",
  ycoord = "ycoord")
table <- TargetExtent %>% select(Category,nResp,Estimate.U,LCB95Pct.U,UCB95Pct.U)
hux <- as_hux(table)
number_format(hux) <- 2
theme_plain(hux)
```

The conclusion is that only 1536-3310 lakes in our data frame of 6437 lakes are likely possible to sample. This is valuable to know because we always understood there are far too many lakes in NYS for us to possibly sample. This analysis indicates a large number are likely inaccessible or unsuitable and therefore the actually population we could sample is within the range that is actually possible in the 10yr sampling window.


The following code actually performs the analysis. It uses the number of sampled lakes in each trophic category (both for phosphorus and chlorophyll) to estimate the ratio of the 2423 lakes we could have sampled are eutrophic, mesotrophic, or eutrophic. 

PLEAE NOTE: this presumes that the lakes we didn't sample were random. A reasonable assumption but it's obviously preferable to sample all the lakes in the list to avoid this uncertainty. We certainly should keep this in mind as we are selecting sites for 2021 sampling.

```{r, echo=TRUE, results='asis', message=FALSE, warning=FALSE}
#  Estimate assessment result
CatExtent <- cat_analysis(
  dframe=att,
  vars=c("TP_threshold","CHLA_threshold","TN_threshold"),
  subpops = ,
  siteID = "siteID",
  weight = "WgtAdj",
  xcoord = "xcoord",
  ycoord = "ycoord")

#quickly calculate the percentages
totals<-CatExtent %>% 
  select(Indicator,Category,Estimate.U) %>% 
  rename(total=Estimate.U)
totals$total <- CatExtent$Estimate.U[4]
CatExtent<-merge(CatExtent,totals,by=c('Indicator','Category'),all.x = TRUE)

forplot<-CatExtent %>% 
  mutate(pct=(Estimate.U/total)*100,
         pct_lcb=(LCB95Pct.U/total)*100,
         pct_ucb=(UCB95Pct.U/total)*100) %>% 
  select(Indicator,Category,pct,pct_lcb,pct_ucb) %>% 
  distinct() %>% 
  filter(Category!="Total") %>% 
  gather(percent,results,-Indicator,-Category) %>% 
  mutate(Indicator=ifelse(Indicator=="CHLA_threshold","Trophic Status from ChlA",Indicator),
         Indicator=ifelse(Indicator=="TP_threshold","Trophic Status from Phosphorus",Indicator),
         Indicator=ifelse(Indicator=="TN_threshold","Trophic Status from Nitrogen",Indicator))

table <- forplot %>% 
  spread(percent,results)  %>% 
  rename(Percentage=pct,Lower95Confidence=pct_lcb,Upper95Confidence=pct_ucb)

hux <- as_hux(table)
number_format(hux) <- 2
theme_plain(hux)

forplot$Category <- factor(forplot$Category, levels=c("Good", "Fair", "Poor"))

ggplot(forplot) +
  geom_point(aes(x = Category, y = results, shape=percent))+
  scale_shape_manual(values=c(16,3,3))+
  theme(legend.position = "none")+
  facet_wrap(~Indicator,scales = "free_y")+
  ylim(0,100)+
  labs(title="Distribution of trophic classes across NYS Ponded Waters",y="Percent of Total",x="EPA threshold")
```

Below: using the number of sampled lakes in each microcystin condition category to estimate the ratio of the 2423 lakes we could have sampled that are least or most disturbed. 

```{r, echo=TRUE, results='asis', message=FALSE, warning=FALSE}
#  Estimate assessment result
MicExtent <- cat_analysis(
  dframe=att,
  vars=c("microcystin"),
  subpops = ,
  siteID = "siteID",
  weight = "WgtAdj",
  xcoord = "xcoord",
  ycoord = "ycoord")

#quickly calculate the percentages
totals<-MicExtent %>% 
  select(Indicator,Category,Estimate.U) %>% 
  rename(total=Estimate.U)
totals$total <- MicExtent$Estimate.U[4]
MicExtent<-merge(MicExtent,totals,by=c('Indicator','Category'),all.x = TRUE)

forplot<-MicExtent %>% 
  mutate(pct=(Estimate.U/total)*100,
         pct_lcb=(LCB95Pct.U/total)*100,
         pct_ucb=(UCB95Pct.U/total)*100) %>% 
  select(Indicator,Category,pct,pct_lcb,pct_ucb) %>% 
  distinct() %>% 
  filter(Category!="Total") %>% 
  gather(percent,results,-Indicator,-Category) %>% 
  mutate(Indicator=ifelse(Indicator=="microcystin","Microsystin (detected) condition category",Indicator))

table <- forplot %>% 
  spread(percent,results)  %>% 
  rename(Percentage=pct,Lower95Confidence=pct_lcb,Upper95Confidence=pct_ucb)

hux <- as_hux(table)
number_format(hux) <- 2
theme_plain(hux)

forplot$Category <- factor(forplot$Category, levels=c("Least disturbed","Most disturbed"))

ggplot(forplot) +
  geom_point(aes(x = Category, y = results, shape=percent))+
  scale_shape_manual(values=c(16,3,3))+
  theme(legend.position = "none")+
  facet_wrap(~Indicator,scales = "free_y")+
  ylim(0,100)+
  labs(title="Distribution of microcystin conditions across NYS Ponded Waters",y="Percent of Total",x="Condition category")
```

## Comparison to LMAS Samples

A plot below shows the distribution of the size classes included in the data frame. For comparison, I've plotted the proportion of NYS lakes sampled in each size class since 2010.

```{r, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
#Plotting data frame distribution as well as NYS sample distribution collected since 2010

frame<-att %>% 
  select(PROB_CAT,AREA_CAT) %>% 
  rename(size_category=AREA_CAT) %>% 
  distinct() %>%
  mutate(Probability_Sites = case_when(
    endsWith(size_category, "(1,4]") ~ ((1828/6437)*100),
    endsWith(size_category, "(4,10]") ~ ((2490/6437)*100),
    endsWith(size_category, "(10,20]") ~ ((1003/6437)*100),
    endsWith(size_category, "(20,50]") ~ ((616/6437)*100),
    endsWith(size_category, ">50") ~ ((500/6437)*100))
    ) %>%
  mutate(LMAS_Sites = case_when(
    endsWith(size_category, "(1,4]") ~ (7.64),
    endsWith(size_category, "(4,10]") ~ (16.7),
    endsWith(size_category, "(10,20]") ~ (16.2),
    endsWith(size_category, "(20,50]") ~ (19.3),
    endsWith(size_category, ">50") ~ (40.1)
  )) %>%
  ungroup() %>%
  select(-PROB_CAT) %>% 
  gather(study,percentage,-size_category) %>% 
  arrange(study,size_category) %>% 
  mutate(percentage=as.numeric(percentage),
         size_category=factor(size_category,levels=c("(1,4]","(4,10]","(10,20]","(20,50]",">50")))

ggplot(frame, aes(x=size_category,y=percentage,fill=study)) +
  geom_bar(stat = "identity", position = position_dodge())+
  labs(title="Size classes in the Probability Study versus LMAS samples since 2010",y="Percent of Total",x="Size Category (hectares)")
```

And the following plot shows the comparison of trophic distributions among LMAS most recent august samples since 2010 compared to the probability drawn samples.
NOTE: used ecoregion analysis to generate the LMAS numbers. These are the most recent August sample collected from each lake sampled since 2010 (a total of 473 unique lakes were sampled since 2010).

```{r, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
#  Estimate assessment result
CatExtent2 <- cat_analysis(
  dframe=att,
  vars=c("chla_trophic","phos_trophic"),
  subpops = ,
  siteID = "siteID",
  weight = "WgtAdj",
  xcoord = "xcoord",
  ycoord = "ycoord")

#quickly calculate the percentages
totals<-CatExtent2 %>% 
  select(Indicator,Category,Estimate.U) %>% 
  rename(total=Estimate.U)
totals$total <- CatExtent2$Estimate.U[4]
CatExtent2<-merge(CatExtent2,totals,by=c('Indicator','Category'),all.x = TRUE)

forplot2<-CatExtent2 %>% 
  mutate(pct=(Estimate.U/total)*100,
         pct_lcb=(LCB95Pct.U/total)*100,
         pct_ucb=(UCB95Pct.U/total)*100) %>% 
  select(Indicator,Category,pct,pct_lcb,pct_ucb) %>% 
  distinct() %>% 
  filter(Category!="Total") %>% 
  gather(percent,results,-Indicator,-Category) %>% 
  mutate(Indicator=ifelse(Indicator=="chla_trophic","Trophic Status from ChlA",Indicator),
         Indicator=ifelse(Indicator=="phos_trophic","Trophic Status from Phosphorus",Indicator))%>% 
  spread(percent,results) %>% 
  rename(percent=pct) %>% 
  mutate(study="probability") %>% 
  add_row(Indicator="Trophic Status from ChlA",
          Category="eutrophic",
          study="LMAS",
          percent=((215/473)*100)) %>% 
  add_row(Indicator="Trophic Status from ChlA",
          Category="mesotrophic",
          study="LMAS",
          percent=((182/473)*100)) %>% 
  add_row(Indicator="Trophic Status from ChlA",
          Category="oligotrophic",
          study="LMAS",
          percent=((76/473)*100)) %>% 
  add_row(Indicator="Trophic Status from Phosphorus",
          Category="eutrophic",
          study="LMAS",
          percent=((211/473)*100)) %>% 
  add_row(Indicator="Trophic Status from Phosphorus",
          Category="mesotrophic",
          study="LMAS",
          percent=((141/473)*100)) %>% 
  add_row(Indicator="Trophic Status from Phosphorus",
          Category="oligotrophic",
          study="LMAS",
          percent=((121/473)*100)) %>% 
  mutate(pct_lcb=ifelse(is.na(pct_lcb),percent,pct_lcb),
         pct_ucb=ifelse(is.na(pct_ucb),percent,pct_ucb))
  

ggplot(forplot2, aes(x=Category,fill=study)) +
  geom_bar(aes(y=percent),stat = "identity", position = position_dodge())+
  geom_errorbar(aes(ymin=pct_lcb, ymax=pct_ucb), width=.2,
                 position=position_dodge(.9))+
  facet_wrap(~Indicator,scales = "free_y")+
  labs(title="Trophic Classes in the Probability Study versus LMAS samples since 2010",y="Percent of Total",x="Trophic Classes")
```


## Notes for future study:

To consider the influence of other strata (such as depth or ecoregion) keep the adjusted weights the same and use these categories to define sub populations. If we include two sub populations (see how large shallow lakes fair in trophic status) then it's sliced so thin that the confidence interval is really too large to be of any value. 
The question then is when is it valuable to stratify a study as opposed to using subpopulations in the post analysis? The answer is that it depends on the distribution of sub populations. If one of the sub populations is very small compared to the other, for example Long Island samples versus samples from other eco regions, then we would probably want to stratify the samples to ensure we get a representative set from Long Island. If the sub populations are relatively equal, then there's no reason to stratify.
